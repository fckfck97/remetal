{% extends 'padre/base.html' %} {% block page_content %}
<div class="card shadow mb-4">
  <!-- Card Header - Dropdown -->
  <div
    class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
  >
    <h6 class="m-0 font-weight-bold text-primary">Listado de Facturas</h6>
  </div>
  <!-- Card Body -->
  <div class="card-body">
    <div class="col-md-4">
      <a class="btn btn-success mb-4" href="{% url 'facturacion:nueva_factura'%}"
        ><i class="fa-solid fa-circle-plus"></i> Nuevo</a
      >
    </div>

    {% if not obj %}
    <div class="alert alert-info">No Hay Facturas</div>
    {% endif %}

    <table
    id="table"
    data-toggle="table"
    data-pagination="true"
    data-search="true"
    data-toolbar=".buttons-toolbar"
    data-locale="es-MX"
    >
      <thead align="center">
        <th data-field="no_factura">No. Factura</th>
        <th data-field="cliente">Cliente</th>
        <th data-field="fecha_factura">F. Factura</th>
        <th data-field="sub_total">Sub Total</th>
        <th data-field="descuento">Descuento</th>
        <th data-field="total">Total</th>
        <th data-field="estado">Estado</th>
        <th class="all">Acciones</th>
      </thead>
      <tbody align="center">
        {% for item in obj%}
        <tr>
          <td>RM-F-{{ item.id }}</td>
          <td>{{ item.cliente.razon_social }}</td>
          <td>{{ item.fecha }}</td>
          <td>{{ item.sub_total }}$</td>
          <td>{{ item.descuento }}$</td>
          <td>{{ item.total }}$</td>
          <td>{{item.estado|yesno:"Activo,Inactivo"}}</td>
          <td>
            <a
              class="btn btn-warning btn-circle"
              href="{% url 'compra:editar_compra' item.id %}"
              ><i class="far fa-edit"></i
            ></a>
            <a
              class="btn btn-danger btn-circle"
              onclick="return abrir_modal('{% url 'compra:eliminar_enc' item.id %}')"
              target="reportes"
              ><i class="fas fa-trash"></i
            ></a>
            <button
              type="button"
              class="btn btn-warning btn-circle"
              onclick="pagar_factura({{ item.id }})"
            >
              <i class="fa-solid fa-money-bill"></i>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
        

    <div class="row p-1">
      <div class="col-lg-12">
        <h6 class="m-0 font-weight-bold text-primary">
          Listado de Compras Pagadas
        </h6>
        {% if obj2 %}
        <table
        id="table"
        data-toggle="table"
        data-pagination="true"
        data-search="true"
        data-toolbar=".buttons-toolbar"
        data-locale="es-MX"
        >
          <thead align="center">
            <th data-field="no_factura">No. Factura</th>
            <th data-field="nombres">Cliente</th>
            <th data-field="fecha_factura">F. Factura</th>
            <th data-field="apellidos">Total</th>
            <th data-field="metodo_pago">Metodo de Pago</th>
            <th data-field="monto_pago">Monto Pagado</th>
            <th data-field="estado">Estado</th>
            
            <th class="all">Usuario</th>
            <th class="all">Acciones</th>
          </thead>
          <tbody align="center">
            {% for item in obj2 %}

            <tr>
              <td>RM-F-{{ item.id }}</td>
              <td>{{ item.cliente.razon_social }}</td>
              <td>{{ item.fecha }}</td>
              <td>{{ item.total }}$</td>
              <td>{{ item.tipo_pago }}</td>
              <td>{{ item.monto }}</td>
              {% if item.pagado %}
              <td>Pagado</td>
              {% endif %}
              
              <td>{{ item.user_cobra }}</td>
              {% if item.total <= 0 %}
              <td>Factura Invalida</td>
              {% else %}
              <td>
                <a
                  class="btn btn-success btn-circle"
                  href="{% url 'facturacion:factura_imprimir_one' item.id%}"
                  target="reportes"
                  ><i class="fas fa-print"></i
                ></a>
              </td>
              {% endif %}
            </tr>

            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block js_page %}
<script>
    function pagar_factura(id)
      {
          // mensaje(id);
          $.confirm({
              theme:"material",
              icon:"fas fa-dollar-sign",
              type:'green',
              title: "Pago de Factura",
              content: 'url:/facturacion/factura/pago_factura/' + id,
              buttons:{
                  borrar:{
                      text:"Pago",
                      btnClass:"btn btn-success",
                      action: function(){
                        var metodo = this.$content.find('select#metodo');
                        var monto = this.$content.find('input#monto');
                        var data = {"metodo":metodo.val(),"monto":monto.val()};
  	                    console.log(data);

                          var token = '{{csrf_token}}';
                          $.ajax({
                              headers: { "X-CSRFToken": token },
                              type:"POST",
                              data:data,
                              url: '/facturacion/factura/pago_factura/' + id,
                              success: function(r){
                                  console.log(r);
                                  if(r==="ok"){
                                      location.reload(true);
                                  }else{
                                      mensaje(r,'red');
                                  }
                              },
                              error: function(a,b,c){
                                  mensaje(c);
                              }
                          });
                      }
                      },
                  cancelar: function(){}
                  }
          });
      }
  
</script>
{% endblock %}
